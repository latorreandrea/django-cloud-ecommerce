{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Main checkout form -->
    <div class="col-lg-7">
        <main id="checkout-main">
          <h1 class="mb-4">Checkout</h1>
          <form id="checkout-form" method="post" novalidate>
            {% csrf_token %}
            {{ form|crispy }}
            <!-- Payment section -->
            <section class="mb-4">
              <h2 class="h5">Payment</h2>
              <p>Total: <strong>{{ cart_total }} €</strong></p>
              <div id="card-element" class="mb-3"><!-- Stripe Elements --></div>
              <div id="card-errors" class="text-danger mb-2"></div>
              <button id="submit" class="btn btn-success w-100">Pay now</button>
            </section>
          </form>
        </main>
      </div>
    <!-- Order summary -->
    <div class="col-lg-5">
      <aside class="bg-light p-4 rounded shadow-sm mt-4 mt-lg-0">
        <h2 class="h5 mb-3">Order summary</h2>
        {% if cart_items %}
          <ul class="list-group mb-3">
            {% for item in cart_items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ item.product.name|truncatewords:6 }}</div>
                  <img src="{{ item.image_url }}" alt="{{ item.color.name }}" style="width:35px; height:35px;">
                </div>
                <span>{{ item.price }} €</span>
              </li>
            {% endfor %}
          </ul>
          <div class="d-flex justify-content-between">
            <span class="fw-bold">Total</span>
            <span class="fw-bold">{{ cart_total }} €</span>
          </div>
        {% else %}
          <p>Your cart is empty.</p>
        {% endif %}
      </aside>
    </div>
  </div>
</div>
{% endblock %}

{% block postloadjs %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe('{{ stripe_public_key }}');
  const elements = stripe.elements();
  const card = elements.create('card');
  card.mount('#card-element');
  const form = document.getElementById('checkout-form');
  form.addEventListener('submit', function(event) {
    event.preventDefault();
    stripe.confirmCardPayment('{{ client_secret }}', {
      payment_method: {
        card: card,
        billing_details: {
          name: document.getElementById('full_name').value,
          email: document.getElementById('email_address').value
        }
      }
    }).then(function(result) {
      if (result.error) {
        document.getElementById('card-errors').textContent = result.error.message;
      } else {
        if (result.paymentIntent.status === 'succeeded') {
          form.submit(); // oppure redirect
        }
      }
    });
  });
</script>
{% endblock %}