{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container my-5">
  <div class="row">
    <!-- Main checkout form -->
    <div class="col-lg-7">
      <main id="checkout-main">
        <h1 class="mb-4">Checkout</h1>
        <form id="checkout-form" method="post" novalidate>
          {% csrf_token %}
          <!-- Shipment Info -->
          <div class="card mb-3">
            <div class="card-header" id="heading-shipping">
              <h2 class="mb-0">
                <button class="btn btn-link fw-bold text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-shipping" aria-expanded="true" aria-controls="collapse-shipping">
                  Shipping Info – Your tees are itching to travel!
                </button>
              </h2>
            </div>
            <div id="collapse-shipping" class="collapse show" aria-labelledby="heading-shipping">
              <div class="card-body" id="shipping-fields">
                {{ form.full_name|as_crispy_field }}
                {{ form.email_address|as_crispy_field }}
                {{ form.phone_number|as_crispy_field }}
                {{ form.street_address1|as_crispy_field }}
                {{ form.street_address2|as_crispy_field }}
                {{ form.town_or_city|as_crispy_field }}
                {{ form.county|as_crispy_field }}
                {{ form.postcode|as_crispy_field }}
                {{ form.country|as_crispy_field }}
              </div>
            </div>
          </div>

            <!-- Checkbox for different billing address -->
            <div class="form-check my-3">
              <input class="form-check-input" type="checkbox" id="billing-different" name="billing_different">
              <label class="form-check-label" for="billing-different">
                The billing address is different from the shipping address
              </label>
            </div>

            <!-- Billing Info -->
            <div class="card mb-3" id="billing-card" style="display: none;">
              <div class="card-header" id="heading-billing">
                <h2 class="mb-0">
                  <button class="btn btn-link fw-bold text-decoration-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-billing" aria-expanded="false" aria-controls="collapse-billing" id="billing-summary-btn">
                    Billing Info – Boring but important!
                  </button>
                </h2>
              </div>
              <div id="collapse-billing" class="collapse" aria-labelledby="heading-billing">
                <div class="card-body" id="billing-fields">
                  {{ form.billing_full_name|as_crispy_field }}
                  {{ form.billing_email_address|as_crispy_field }}
                  {{ form.billing_phone_number|as_crispy_field }}
                  {{ form.billing_street_address1|as_crispy_field }}
                  {{ form.billing_street_address2|as_crispy_field }}
                  {{ form.billing_town_or_city|as_crispy_field }}
                  {{ form.billing_county|as_crispy_field }}
                  {{ form.billing_postcode|as_crispy_field }}
                  {{ form.billing_country|as_crispy_field }}
                </div>
              </div>
            </div>
            <!-- Payment section -->
            <section class="mb-4">
              <h2 class="h5">Payment</h2>
              <p>Total: <strong>{{ cart_total }} €</strong></p>
              <div id="card-element" class="mb-3"></div>
              <div id="card-errors" class="text-danger mb-2"></div>
              <button id="submit" class="btn btn-success w-100">Pay now</button>
            </section>
        </form>
      </main>
    </div>
    <!-- Order summary -->
    <div class="col-lg-5">
      <aside class="bg-light p-4 rounded shadow-sm mt-4 mt-lg-0">
        <h2 class="h5 mb-3">Order summary</h2>
        {% if cart_items %}
          <ul class="list-group mb-3">
            {% for item in cart_items %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">{{ item.product.name|truncatewords:6 }}</div>
                  <img src="{{ item.image_url }}" alt="{{ item.color.name }}" style="width:35px; height:35px;">
                </div>
                <span>{{ item.price }} €</span>
              </li>
            {% endfor %}
          </ul>
          <div class="d-flex justify-content-between">
            <span class="fw-bold">Total</span>
            <span class="fw-bold">{{ cart_total }} €</span>
          </div>
        {% else %}
          <p>Your cart is empty.</p>
        {% endif %}
      </aside>
    </div>
  </div>
</div>
{% endblock %}

{% block postloadjs %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const billingCheckbox = document.getElementById('billing-different');
      const billingCard = document.getElementById('billing-card');
      billingCheckbox.addEventListener('change', function() {
        if (this.checked) {
          billingCard.style.display = 'block';
        } else {
          billingCard.style.display = 'none';
        }
      });
    });
  </script>
  {{ block.super }}
  {{ stripe_public_key|json_script:"id_stripe_public_key" }}
  {{ client_secret|json_script:"id_client_secret" }}
  <script src="https://js.stripe.com/v3/"></script>
  <script src="{% static 'checkout/js/stripe_elements.js' %}"></script>
{% endblock %}